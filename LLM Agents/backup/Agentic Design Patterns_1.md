# Agentic Design Patterns
# A Hands-On Guide to Building Intelligent Systems1, Antonio Gulli

## Table of Contents - total 424 pages = 1+2+1+1+4+9+103+61+34+114+74+5+4 11

Dedication, 1 page
Acknowledgment, 2 pages [final, last read done]
Foreword, 1 page [final, last read done]
A Thought Leader's Perspective: Power and Responsibility [final, last read done]
Introduction, 4 pages [final, last read done]
What makes an AI system an "agent"?, 9 pages [final, last read done]

## Part One, (Total: 103 pages)
1. Chapter 1: Prompt Chaining (code), 12 pages [final, last read done, code ok]
2. Chapter 2: Routing (code), 13 pages [fina, last read done, code ok]
3. Chapter 3: Parallelization (code), 15 pages [final, last read done, code okl]
4. Chapter 4: Reflection (code), 13 pages [final, last read done, code okl]
5. Chapter 5: Tool Use (code), 20 pages [final, last read done, code ok]
6. Chapter 6: Planning (code), 13 pages [final, last read done, code ok]
7. Chapter 7: Multi-Agent (code), 17 pages [final, last read done, code ok], 121

## Part Two (Total: 61 pages)
8. Chapter 8: Memory Management (code), 21 pages [final, last read done, code ok]
9. Chapter 9: Learning and Adaptation (code), 12 pages [final, last read done, code ok]
10. Chapter 10: Model Context Protocol (MCP) (code), 16 pages [final, last read done, code ok]
11. Chapter 11: Goal Setting and Monitoring (code), 12 pages [final, last read don, code oe], 182

## Part Three (Total: 34 pages)
12. Chapter 12: Exception Handling and Recovery (code), 8 pages [final, last read done, code ok]
13. Chapter 13: Human-in-the-Loop (code), 9 pages [final, last read done, code ok]
14. Chapter 14: Knowledge Retrieval (RAG) (code), 17 pages [final, last read done, code ok], 216

## Part Four (Total: 114 pages)
15. Chapter 15: Inter-Agent Communication (A2A) (code), 15 pages [final, last read done, code ok]
16. Chapter 16: Resource-Aware Optimization (code), 15 pages [final, last read done, code ok]
17. Chapter 17: Reasoning Techniques (code), 24 pages [final, last read done, code ok]
18. Chapter 18: Guardrails/Safety Patterns (code), 19 pages [final, last read done, code ok]
19. Chapter 19: Evaluation and Monitoring (code), 18 pages [final, last read done, code ok]
20. Chapter 20: Prioritization (code), 10 pages [final, last read done, code ok ]
21. Chapter 21: Exploration and Discovery (code), 13 pages [final, last read done, code ok], 330

## Appendix (Total: 74 pages)
22. Appendix A: Advanced Prompting Techniques, 28 pages [final, last read done, code ok]
23. Appendix B - AI Agentic ….: From GUI to Real world environment, 6 pages [final, last read done, code ok]
24. Appendix C - Quick overview of Agentic Frameworks, 8 pages [final, last read done, code ok],
25. Appendix D - Building an Agent with AgentSpace (on-line only), 6 pages [final, last read done, code ok]
26. Appendix E - AI Agents on the CLI (online), 5 pages [final, last read done, code ok]
27. Appendix F - Under the Hood: An Inside Look at the Agents' Reasoning Engines, 14 pages [final, lrd, code ok],
28. Appendix G - Coding agents, 7 pages 406
Conclusion, 5 pages [final, last read done]
Glossary, 4 pages [final, last read done]
Index of Terms, 11 pages (Generated by Gemini. Reasoning step included as an agentic example) [final, lrd]
Online contribution - Frequently Asked Questions: Agentic Design Patterns
Pre Print: https://www.amazon.com/Agentic-Design-Patterns-Hands-Intelligent/dp/3032014018/

1 All my royalties will be donated to Save the Children

---

## 献词

致我的儿子布鲁诺，
你两岁时，为我的人生带来了崭新而灿烂的光芒。当我探索那些将定义我们未来的系统时，我首先想到的是你将要继承的世界。

致我的儿子莱昂纳多和洛伦佐，以及我的女儿奥罗拉，
我为你们成长为优秀的男女，以及正在建设的美好世界而感到骄傲。这本书是关于如何构建智能工具的，但我把它献给深切的希望——希望你们这一代能够以智慧和同情心来引导这些工具。如果我们学会利用这些强大的技术为人类服务并推动进步，未来对于你们和我们所有人来说都将是无限光明的。致我全部的爱。

---

## 致谢

我想向许多个人和团队表达我诚挚的谢意，是你们让这本书成为可能。

首先，我要感谢谷歌公司坚守其使命，赋能谷歌员工，并尊重创新的机会。我感谢CTO办公室给我探索新领域的机会，感谢它坚守"实用魔法"的使命，并具备适应新兴机遇的能力。

我要向威尔·格兰尼斯副总裁致以衷心的感谢，感谢他对人的信任和作为仆人式领导者的品质。感谢我的经理约翰·阿贝尔鼓励我追求我的活动，并总是以他英式的睿智提供卓越的指导。我感谢安托万·拉尔曼雅在代码LLM方面的工作，韩寒王在智能体讨论方面的贡献，以及黄英超在时间序列洞察方面的见解。感谢阿什温·拉姆的领导，梅西·马斯卡罗的鼓舞人心的工作，詹妮弗·贝内特的技术专长，布雷特·斯莱特金的工程才能，以及埃里克·申的启发性的讨论。OCTO团队，特别是斯科特·彭伯西值得称赞。最后，深切感谢帕特里夏·弗洛里西对智能体社会影响的鼓舞愿景。

我还要感谢马可·阿金蒂提出的关于智能体增强人类劳动力的挑战性和激励性的愿景。感谢吉姆·兰齐昂和乔迪·里巴斯推动搜索世界和智能体世界之间的关系。

我也 indebted to Cloud AI团队，特别是他们的 leader Saurabh Tiwary，推动AI组织向着有原则的进步发展。感谢区域技术主管 Salem Salem Haykal 作为一位鼓舞人心的同事。感谢谷歌Agent空间的联合创始人弗拉基米尔·武斯科维奇，感谢凯特（卡塔兹娜）奥尔谢夫斯卡在Kaggle游戏竞技场上的智能体合作，感谢内特·基廷充满激情地推动Kaggle，这个社区为AI做出了如此多的贡献。我还要感谢卡梅莉亚·阿里亚法，领导专注于Agent空间和企业NotebookLM的应用AI和ML团队，以及雅恩·伍兰，一位真正专注于交付的领导者，也是一位总是在那里提供建议的个人朋友。

特别感谢黄英超是一位才华横溢的AI工程师，在你面前有伟大的职业前景，感谢韩寒王挑战我在1994年初次对智能体产生兴趣后重新回到这个领域，感谢李·布斯特拉在提示工程方面的惊人工作。

我还要感谢5 Days of GenAI团队，包括我们的副总裁艾莉森·瓦根费尔德对团队的信任，阿南特·纳瓦尔加里亚总是能够交付成果，以及佩奇·贝利的积极态度和领导力。

我也深深感谢迈克·斯蒂尔、图兰·布尔穆斯和坎查纳·帕托拉帮助我在谷歌I/O 2025上发布了三个智能体。感谢你们巨大的工作。

我想向托马斯·库里安表达我诚挚的谢意，感谢他在推动云和AI倡议方面坚定不移的领导力、激情和信任。我也深深感谢伊曼纽尔·塔罗帕，他鼓舞人心的"能做到"态度使他成为我在谷歌遇到的最杰出的同事，树立了真正深刻的榜样。最后，感谢菲奥娜·西科尼就谷歌进行的精彩讨论。

我向德米斯·哈萨比斯、普什米特·科利和整个GDM团队致以谢意，感谢他们在开发Gemini、AlphaFold、AlphaGo和AlphaGenome等项目以及其他项目方面的热情努力，以及他们为推动科学造福社会所做的贡献。特别感谢约西·马蒂亚斯对谷歌研究的领导，并始终提供宝贵的建议。我从你那里学到了很多。

特别感谢帕蒂·莫斯，她在90年代开创了软件智能体的概念，并始终专注于计算机系统和数字设备如何增强人们并协助他们处理记忆、学习、决策、健康和福祉等问题。你在'91年的愿景今天已经成为现实。

我还要向保罗·德鲁加斯和施普林格的所有出版团队致以谢意，让这本书成为可能。

我深深地 indebted to 许多帮助将这本书带到生命的才华横溢的人。我衷心感谢马可·法戈的巨大贡献，从代码和图表到审阅整个文本。我也感谢马赫塔布·赛德的编码工作和安基塔·古哈在许多章节提供的极其详细的反馈。普里娅·萨克斯纳富有洞察力的修改，杰·李仔细的审阅，以及马里奥·达罗萨在创建NotebookLM版本方面的专门工作，都显著地提高了这本书的质量。我有幸拥有一支专家评审团队来审阅初始章节，我感谢阿米塔·卡普尔博士、法特玛·塔尔拉奇博士、亚历山德罗·科尔纳基亚博士和阿迪蒂亚·曼德尔卡提供他们的专业知识。我也真诚地感谢阿什利·米勒、阿米尔·约翰和帕拉克·卡姆达尔（瓦萨尼）的独特贡献。

对于他们坚定的支持和鼓励，最后要热情地感谢拉贾特·贾恩、阿尔多·帕霍尔、高拉夫·维尔马、帕维特拉·塞纳特、马里乌什·科茨瓦拉、阿比吉特·库马尔、阿姆斯特朗·方德杰、冉海明、乌迪塔·帕特尔和考尔纳卡尔·科塔。没有你们，这个项目真的不可能实现。

所有功劳都归功于你们，
所有的错误都是我的。

我的所有版税都将捐赠给拯救儿童基金会。

---

## 前言

人工智能领域正处于一个迷人的转折点。我们正在超越构建仅仅处理信息的模型，转向创造能够推理、规划并行动以实现复杂目标（任务模糊）的智能系统。正如本书如此恰当描述的那样，这些"智能体"系统代表了AI的下一个前沿，它们的发展是激发和激励我们谷歌的挑战。

《智能体设计模式：构建智能系统的实践指南》恰逢其时，为我们的旅程提供指导。本书正确地指出，大型语言模型的力量——这些智能体的认知引擎——必须通过结构和深思熟虑的设计来利用。正如设计模式通过提供通用语言和可重用的解决方案来解决常见问题，从而彻底改变了软件工程一样，本书中的智能体模式将成为构建健壮、可扩展和可靠智能系统的基石。

构建智能体系统的"画布"这个比喻与我们在谷歌Vertex AI平台上的工作产生了深刻共鸣。我们努力为开发者提供最强大和灵活的画布来构建下一代AI应用程序。本书提供了实用的、动手操作的指导，将赋能开发者充分利用该画布的潜力。

通过探索从提示链和工具使用到智能体间协作、自我纠正、安全和护栏等模式，本书为任何希望构建复杂AI智能体的开发者提供了全面的工具包。

AI的未来将由能够构建这些智能系统的开发者的创造力和才华定义。《智能体设计模式》是一个不可或缺的资源，将有助于释放这种创造力。它提供了基本知识和实践示例，不仅能够理解智能体系统的"什么"和"为什么"，还能理解"如何"。

我很高兴看到这本书到达开发者社区手中。这些页面中的模式和原则无疑将加速创新和有影响力的AI应用程序的开发，这些应用程序将在未来几年塑造我们的世界。

萨鲁拉布·蒂瓦里
副总裁兼总经理，CloudAI @ 谷歌

---

## 思想领袖的视角：权力与责任

在我过去四十年见证的所有技术周期中——从个人电脑和网络的诞生，到移动和云的革命——没有一次感觉像这次这样。多年来，围绕人工智能的讨论是炒作与幻灭的熟悉节奏，即所谓的"AI之夏"之后是漫长的"AI之冬"。但这一次，有些不同。对话发生了明显的变化。

如果过去的十八个月是关于引擎——大型语言模型（LLMs）令人叹为观止的、几乎是垂直的崛起——那么下一个时代将是关于我们围绕它构建的汽车。它将是关于利用这种原始力量的框架，将其从生成可信文本的生成器转变为真正的行动代理。

我承认，我开始时是一个怀疑者。我发现，可信度往往与一个人对主题的了解程度成反比。早期模型尽管流利，但感觉像是在用一种冒名顶替综合症运作，为可信度而非正确性进行了优化。但随后出现了转折点，由一类新的"推理"模型带来的阶跃变化。突然间，我们不仅仅是在与预测序列中下一个单词的统计机器对话；我们正在窥视一种新生的认知形式。

当我第一次尝试使用一种新的智能体编码工具时，我感受到了那种熟悉的魔火花。我给它分配了一个我从未找到时间做的个人项目：将一个慈善网站从简单的网站构建器迁移到合适的现代CI/CD环境。在接下来的二十分钟里，它开始工作，提出澄清问题，请求凭据，并提供状态更新。感觉不像是在使用工具，更像是与初级开发人员合作。当它向我展示一个完全可部署的包，包含无可挑剔的文档和单元测试时，我被震撼了。

当然，它并不完美。它会犯错误。它会卡住。它需要我的监督，关键是，我的判断来引导它回到正轨。这段经历让我深刻体会到了我在漫长职业生涯中艰难学到的一课：你不能盲目信任。然而，这个过程是迷人的。窥视它的"思维链"就像看着大脑在工作——杂乱、非线性，充满开始、停止和自我纠正，就像我们自己的人类推理一样。它不是一条直线；它是朝向解决方案的随机游走。

这里孕育着新事物的种子：不仅是能够生成内容的智能，而且是能够生成计划的智能。

这就是智能体框架的承诺。它是静态地铁地图和动态GPS之间的区别，后者会实时重新规划你的路线。经典的基于规则的自动化器遵循固定路径；当遇到意外障碍时，它会崩溃。由推理模型驱动的AI智能体有潜力观察、适应并找到另一种方式。它拥有一种数字常识形式，使其能够驾驭现实中无数的边缘情况。它代表了一种转变，从简单地告诉计算机做什么，到解释为什么我们需要完成某事并信任它找出如何做。

正如这个新前沿令人振奋一样，它带来了一种深刻的责任感，特别是从我作为全球金融机构CIO的角度来看。风险极高。一个在创建"鸡三文鱼融合派"食谱时犯错的智能体只是一个有趣的轶事。一个在执行交易、管理风险或处理客户数据时犯错的智能体是一个真正的问题。我读过免责声明和警示故事：网络自动化智能体在登录失败后，决定给国会议员发邮件抱怨登录墙。这是一个黑色幽默的提醒，我们正在处理一种我们不完全理解的技术。

在这里，技艺、文化和对我们原则的不懈关注成为我们的基本指南。我们的工程准则不仅仅是页面上的文字；它们是我们的指南针。我们必须有目的地构建，确保我们设计的每个智能体都从清楚理解的客户问题开始。我们必须环顾四周，预见故障模式并设计具有弹性设计的系统。最重要的是，我们必须激发信任，对我们的方法保持透明，对我们的结果负责。

在智能体世界中，这些准则变得紧迫起来。严酷的真相是，你不能简单地将这些强大的新工具叠加到混乱、不一致的系统上并期望得到好的结果。混乱的系统加上智能体是灾难的根源。在"垃圾"数据上训练的AI不仅仅产生垃圾输出；它产生的是自信的、可信的垃圾，可能毒害整个过程。因此，我们最关键和最重要的任务是准备基础。我们必须投资于干净的数据、一致的元数据和定义良好的API。我们必须建设现代化的"州际公路系统"，让这些智能体能够安全高速运行。这是构建可编程企业的艰难基础工作，即"作为软件的企业"，我们的流程和我们的代码一样架构良好。

归根结底，这段旅程不是要取代人类的聪明才智，而是要增强它。它要求我们每个人都具备一套新的技能：清晰解释任务的能力、授权的智慧，以及验证输出质量的勤奋。它要求我们谦逊，承认我们不知道的，并且永不停止学习。本书后续页面提供了构建这些新框架的技术地图。我的希望是，你们不仅会用它们来构建可能的东西，还会用来构建正确的、健壮的和负责任的东西。

世界要求每个工程师都挺身而出。我相信我们已准备好迎接挑战。享受这段旅程。

马可·阿金蒂，CIO，高盛

---

## 前言

欢迎阅读《智能体设计模式：构建智能系统的实践指南》。当我们纵观现代人工智能的图景时，我们看到了从简单、反应式程序到能够理解上下文、做出决策并与环境和其他系统动态交互的复杂、自主实体的清晰演进。这些就是智能智能体和它们组成的智能体系统。

强大的大型语言模型（LLMs）的出现为理解和生成人类般的内容（如文本和媒体）提供了前所未有的能力，作为许多这些智能体的认知引擎。然而，将这些能力协调成能够可靠实现复杂目标的系统需要的不仅仅是一个强大的模型。它需要结构、设计，以及对智能体如何感知、规划、行动和交互的深思熟虑的方法。

将构建智能系统想象成在画布上创作复杂的艺术品或工程。这个画布不是空白的视觉空间，而是为你的智能体存在和操作提供环境和工具的基础设施和框架。它是你将构建智能应用程序的基础，管理状态、通信、工具访问和逻辑流。

在这个智能体画布上有效构建需要的不仅仅是简单地将组件组合在一起。它需要理解经过验证的技术——模式——来解决在设计和实施智能体行为时面临的共同挑战。正如建筑模式指导建筑物的建造，或设计模式构建软件一样，智能体设计模式为在你选择的画布上让智能体焕发生机时面临的重复问题提供了可重用的解决方案。

### 什么是智能体系统？

在其核心，智能体系统是一个计算实体，旨在感知其环境（数字的和潜在的物理的），基于这些感知和一组预定义或学习到的目标做出明智的决策，并自主执行行动以实现这些目标。与传统软件遵循 rigid、逐步指令不同，智能体表现出一定程度的灵活性和主动性。

想象你需要一个系统来管理客户咨询。传统系统可能遵循固定脚本。然而，智能体系统可以感知客户查询的细微差别，访问知识库，与其他内部系统（如订单管理）交互，可能提出澄清问题，并主动解决问题，甚至可能预见未来需求。这些智能体在你的应用程序基础设施的画布上运行，利用它们可用的服务和数据。

智能体系统通常具有自主性、能够在没有持续人工监督的情况下行动；主动性，朝着其目标发起行动；和反应性，有效响应环境变化等特征。它们是目标导向的，不断朝着目标努力。一个关键能力是工具使用，使它们能够与外部API、数据库或服务交互——有效地超出其直接画布的范围。它们拥有记忆，在交互中保留信息，并能够与用户、其他系统，甚至在相同或连接画布上运行的其他智能体进行通信。

有效实现这些特征带来了显著的复杂性。智能体如何在其画布上的多个步骤中维持状态？它如何决定何时以及如何使用工具？不同智能体之间的通信如何管理？你如何在系统中构建弹性以处理意外结果或错误？

### 为什么模式在智能体开发中很重要

这种复杂性正是为什么智能体设计模式不可或缺的原因。它们不是严格的规则，而是经过战斗测试的模板或蓝图，为智能体领域中的标准设计和实施挑战提供经过验证的方法。

通过识别和应用这些设计模式，你可以获得增强在你画布上构建的智能体的结构、可维护性、可靠性和效率的解决方案。使用设计模式有助于你避免重新发明基本解决方案，如管理对话流程、集成外部能力或协调多个智能体行动。它们提供了通用语言和结构，使你的智能体逻辑更清晰，更容易让其他人（和未来的你）理解和维护。实施专为错误处理或状态管理设计的模式直接有助于构建更健壮和可靠的系统。利用这些已建立的方法加速你的开发过程，让你能够专注于应用程序的独特方面，而不是智能体行为的基础机制。

本书提取了21个关键设计模式，代表了在各种技术画布上构建复杂智能体的基本构建块和技术。理解和应用这些模式将显著提高你有效设计和实施智能系统的能力。

### 书籍概述及如何使用

本书《智能体设计模式：构建智能系统的实践指南》旨在成为实用且易于理解的资源。其主要重点是清晰地解释每个智能体模式，并提供具体的、可运行的代码示例来演示其实施。

在21个专门章节中，我们将探索多样的设计模式，从基础概念如结构化顺序操作（提示链）和外部交互（工具使用）到更高级的主题如协作工作（多智能体协作）和自我改进（自我纠正）。

本书按章节组织，每章深入研究单一的智能体模式。在每个章节中，你会发现：

● 详细的模式概述，清晰解释模式及其在智能体设计中的作用。
● 实际应用和用例部分，说明模式在现实世界场景中的宝贵价值和带来的好处。
● 动手代码示例，提供实用的、可运行的代码，演示使用知名智能体开发框架的模式实施。在这里你将看到如何在技术画布的上下文中应用模式。
● 关键要点，总结最重要的观点以便快速回顾。
● 进一步探索的参考，提供有关模式和概念的更深入学习资源。

虽然章节按递进概念排序，但请随意将本书作为参考，跳转到解决你自己智能体开发项目中面临的具体挑战的章节。附录全面介绍了高级提示技术、在现实世界环境中应用AI智能体的原则，以及基本智能体框架的概述。为了补充这一点，包括实用的在线教程，提供使用特定平台如AgentSpace和命令行界面构建智能体的分步指导。整个强调的是实际应用；我们强烈鼓励你运行代码示例，进行实验，并调整它们以在你选择的画布上构建你自己的智能系统。

我听到的一个很好的问题是，'随着AI变化如此之快，为什么要写一本可能很快过时的书？'我的动机恰恰相反。正是因为事情变化如此之快，我们需要退后一步，识别正在固化的基本原则。像RAG、反思、路由、记忆等模式，正在成为基本的构建块。这本书是对这些核心思想的反思邀请，它们提供了我们需要在其上构建的基础。人类需要对这些基础模式进行反思时刻

### 所用框架简介

为了为我们的代码示例提供可触摸的"画布"（另见附录），我们将主要利用三个知名的智能体开发框架。LangChain及其有状态扩展LangGraph提供了将语言模型和其他组件链接在一起的灵活方式，为构建复杂序列和操作图提供了强大的画布。Crew AI提供了专门设计用于协调多个AI智能体、角色和任务的结构化框架，作为特别适合协作智能体系统的画布。谷歌智能体开发工具包（Google ADK）提供了构建、评估和部署智能体的工具和组件，提供了另一个有价值的画布，通常与谷歌的AI基础设施集成。

这些框架代表了智能体开发画布的不同方面，各有其优势。通过在这些工具中展示示例，无论你为你的智能体系统选择什么特定的技术环境，你都将获得如何应用这些模式的更广泛理解。这些示例旨在清晰说明模式的核心逻辑及其在框架画布上的实施，专注于清晰性和实用性。

到本书结束时，你不仅将理解21个基本智能体模式背后的基本概念，还将拥有有效应用它们的实用知识和代码示例，使你能够在选择的开发画布上构建更智能、更有能力和更自主的系统。让我们开始这个实践之旅吧！

---

## 是什么让AI系统成为智能体？

简单来说，AI智能体是一个旨在感知其环境并采取行动以实现特定目标的系统。它是从标准大型语言模型（LLM）的演进，增强了规划、使用工具和与周围环境交互的能力。

将智能体AI想象成一个在工作中学习的智能助手。它遵循一个简单的五步循环来完成任务（见图1）：
1. 接受任务：你给它一个目标，比如"整理我的日程表"。
2. 扫描场景：它收集所有必要信息——阅读邮件、检查日历和访问联系人——以了解正在发生的事情。
3. 深入思考：它通过考虑实现目标的最优方法来制定行动计划。
4. 采取行动：它通过发送邀请、安排会议和更新你的日历来执行计划。
5. 学习改进：它观察成功结果并相应调整。例如，如果会议重新安排，系统会从这个事件中学习以提高未来性能。

图1：智能体AI作为智能助手运行，通过经验不断学习。它通过简单的五步循环来完成任务。

智能体正以惊人的速度变得越来越受欢迎。根据最近的研究，大多数大型IT公司正在积极使用这些智能体，其中五分之一是在过去一年内开始的。金融市场也在关注。到2024年底，AI智能体初创公司已筹集超过20亿美元，市场价值为52亿美元。预计到2034年，其价值将激增至近2000亿美元。简而言之，所有迹象都表明AI智能体将在我们未来的经济中发挥巨大作用。

在短短两年内，AI范式发生了戏剧性转变，从简单自动化转向复杂的自主系统（见图2）。最初，工作流依赖基本提示和触发器来用LLMs处理数据。这随着检索增强生成（RAG）而发展，通过基于事实信息锚定模型来增强可靠性。然后我们看到能够使用各种工具的个体AI智能体的发展。今天，我们正在进入智能体AI时代，在那里专门的智能体团队协同工作以实现复杂目标，标志着AI协作能力的重大飞跃。

图2：从LLMs到RAG，再到智能体RAG，最后到智能体AI的过渡。

本书的意图是讨论专门智能体如何协调工作并协作以实现复杂目标的设计模式，你将在每章中看到一个协作和交互的范式。

在这样做之前，让我们审视一下跨越智能体复杂性范围的例子（见图3）。

### 0级：核心推理引擎

虽然LLM本身不是智能体，但它可以作为基本智能体系统的推理核心。在"0级"配置中，LLM在没有工具、记忆或环境交互的情况下运行，仅基于其预训练知识响应。它的优势在于利用其广泛的训练数据来解释既定概念。

这种强大的内部推理的权衡是完全缺乏当前事件意识。例如，如果2025年奥斯卡"最佳影片"获奖者在其预训练知识之外，它将无法说出名字。

### 1级：连接的问题解决者

在这个级别，LLM通过连接和利用外部工具成为功能性智能体。它的问题解决不再局限于其预训练知识。相反，它可以执行一系列行动来从互联网（通过搜索）或数据库（通过检索增强生成，或RAG）等来源收集和处理信息。详细信息，请参阅第14章。

例如，为了找到新的电视节目，智能体认识到需要当前信息，使用搜索工具找到它，然后综合结果。关键是，它还可以使用专门的工具以获得更高的准确性，例如调用金融API来获取AAPL的实时股票价格。这种与外部世界跨多个步骤交互的能力是1级智能体的核心能力。

### 2级：战略性问题解决者

在这个级别，智能体的能力显著扩展，包括战略规划、主动协助和自我改进，以提示工程和上下文工程作为核心使能技能。

首先，智能体超越单一工具使用，通过战略性问题解决来处理复杂的多部分问题。当它执行一系列行动时，它主动进行上下文工程：选择、包装和管理每个步骤最相关信息的过程。例如，为了在两个地点之间找到咖啡店，它首先使用地图工具。然后它工程这个输出，策划一个简短、集中的上下文——也许只是一个街道名称列表——输入到本地搜索工具中，防止认知过载并确保第二步高效准确。为了从AI获得最大准确性，必须给它简短、集中和强大的上下文。上下文工程是通过战略性地选择、包装和管理来自所有来源的最关键信息来完成这一点的学科。它有效地策划模型的有限注意力，以防止过载并确保在任何给定任务上高质量、高效的性能。详细信息，请参阅附录A。

这个级别导致主动和持续操作。与你邮件关联的旅行助手通过工程化来自冗长航班确认邮件的上下文来展示这一点；它只选择关键细节（航班号、日期、地点）为后续调用你的日历和天气API打包。

在软件工程等专业领域，智能体通过应用这个学科来管理工作流程。当分配到一个错误报告时，它读取报告并访问代码库，然后战略性地工程这些大量信息源成为一个强大、集中的上下文，使其能够高效地编写、测试和提交正确的代码补丁。

最后，智能体通过改进其自己的上下文工程过程来实现自我改进。当它询问反馈提示如何可以改进时，它正在学习如何更好地策划其初始输入。这使它能够自动改进它为未来任务打包信息的方式，创建一个强大的、自动化的反馈循环，随着时间推移提高其准确性和效率。详细信息，请参阅第17章。

图3：展示智能体复杂性范围的各种实例。

### 3级：协作多智能体系统的兴起

在3级，我们看到了AI发展的重大范式转变，从追求单一的、全能的超级智能体转向复杂的、协作的多智能体系统。本质上，这种方法认识到复杂的挑战通常最好不是由单一通才解决，而是由专家团队协同工作解决。这种模型直接反映了人类组织的结构，在那里不同部门被分配特定角色并协作处理多方面目标。这种系统的集体力量在于劳动分工和通过协调努力创造的协同效应。详细信息，请参阅第7章。

为了让这个概念生动起来，考虑推出新产品的复杂工作流程。而不是一个智能体尝试处理每个方面，一个"项目经理"智能体可以作为中央协调者。这个经理将把任务委托给其他专门智能体来协调整个过程：一个"市场研究"智能体来收集消费者数据，一个"产品设计"智能体来开发概念，以及一个"营销"智能体来制作宣传材料。他们成功的关键将是他们之间无缝的通信和信息共享，确保所有个人努力与实现集体目标一致。

虽然这种自主的、基于团队的自动化愿景已经在开发中，但重要的是要承认当前的障碍。这种多智能体系统的有效性目前受到它们使用的LLMs推理限制的约束。此外，他们真正相互学习和作为有凝聚力的单元改进的能力仍处于早期阶段。克服这些技术瓶颈是关键的下一步，这样做将释放这个层级的深刻承诺：能够从头到尾自动化整个业务工作流程。

### 智能体的未来：5个假设

AI智能体开发正在前所未有的速度在软件自动化、科学研究、客户服务等领域推进。虽然当前的系统令人印象深刻，但这仅仅是开始。下一波创新可能会专注于使智能体更可靠、更协作，并更深入地集成到我们的生活中。以下是关于接下来什么的五个主要假设（见图4）。

#### 假设1：通用智能体的出现

第一个假设是AI智能体将从狭窄的专家演变为能够管理复杂、模糊和长期目标的真正通才，具有高可靠性。例如，你可以给智能体一个简单的提示，如"为我公司30人在里斯本的下季度外出静修做计划。"然后智能体将管理整个项目数周，处理从预算批准和航班谈判到场地选择和根据员工反馈创建详细行程的所有事情，同时提供定期更新。实现这种自主水平将需要AI推理、记忆和近乎完美可靠性的根本突破。

另一种但非互斥的方法是小型语言模型（SLMs）的兴起。这种"乐高式"概念涉及从小型、专门专家智能体组合系统，而不是扩展单一的、庞大的模型。这种方法承诺系统更便宜、调试更快、更容易部署。最终，大型通用模型的开发和较小专门模型的组合都是可行的前进道路，它们甚至可以互补。

#### 假设2：深度个性化和主动目标发现

第二个假设假设智能体将成为深度个性化和主动的伙伴。我们正在见证一类新智能体的出现：主动伙伴。通过学习你独特的模式和目标，这些系统开始从仅仅跟随命令转向预见你的需求。当AI系统超越简单响应聊天或指令时，它们作为智能体运行。它们代表用户发起和执行任务，在过程中积极参与。这超越了简单的任务执行，进入了主动目标发现的领域。

例如，如果你正在探索可持续能源，智能体可能会识别你的潜在目标并主动支持它，建议课程或总结研究。虽然这些系统仍在发展中，但它们的轨迹是清晰的。它们将变得越来越主动，学习在高度确信行动会有帮助时代表你采取主动。最终，智能体成为不可或缺的盟友，帮助你发现和实现你尚未完全表达的雄心。

图4：关于智能体未来的五个假设

#### 假设3：具身化和物理世界交互

这个假设预见智能体打破纯粹数字限制在物理世界中运行。通过将智能体AI与机器人技术集成，我们将看到"具身智能体"的兴起。你不仅可以预约水管工，还可以要求你的家庭智能体修理漏水的水龙头。智能体将使用其视觉传感器感知问题，访问管道知识库制定计划，然后精确控制其机械臂执行修理。这将代表一个巨大步骤，弥合数字智能和物理行动之间的鸿沟，改变从制造业和物流到老年护理和家庭维护的一切。

#### 假设4：智能体驱动的经济

第四个假设是高度自主的智能体将成为经济中的积极参与者，创造新的市场和商业模式。我们可以看到智能体作为独立经济实体行动，被赋予最大化特定结果（如利润）的任务。企业家可以启动一个智能体来运行整个电子商务业务。该智能体将通过分析社交媒体识别趋势产品，生成营销文案和视觉效果，通过与其他自动化系统交互管理供应链物流，并根据实时需求动态调整定价。

这种转变将创造一个新的、超高效的"智能体经济"，以人类无法直接管理的速度和规模运作。

#### 假设5：目标驱动的、变形多智能体系统

这个假设假设从明确编程运行，而是从声明的目标运行的智能系统的出现。用户只需陈述期望的结果，系统就会自主找出如何实现它。这标志着向能够在个体和集体层面真正自我改进的变形多智能体系统的根本转变。

这将是一个动态实体，而不是单一智能体的系统。它将能够分析自己的性能并修改其多智能体工作队的拓扑结构，根据需要创建、复制或删除智能体，为手头的任务形成最有效的团队。这种进化发生在多个层面：

● 架构修改：在最深层次，单个智能体可以重写自己的源代码并重新架构其内部结构以获得更高效率，如原始假设中那样。
● 指令修改：在更高层次，系统持续执行自动提示工程和上下文工程。它优化给每个智能体的指令和信息，确保它们在没有人为干预的情况下以最优指导运行。

例如，企业家只需声明意图："启动一个成功的销售手工咖啡的电子商务业务。"系统，无需进一步编程，就会立即行动。它可能最初产生一个"市场研究"智能体和一个"品牌"智能体。基于初步发现，它可能决定移除品牌智能体并产生三个新的专门智能体：一个"标志设计"智能体，一个"网上商店平台"智能体，以及一个"供应链"智能体。它将不断调整它们的内部提示以获得更好的性能。如果网上商店智能体成为瓶颈，系统可能将其复制成三个并行智能体来处理站点的不同部分，有效地动态重新架构自己的结构以最好地实现声明的目标。

### 结论

本质上，AI智能体代表了从传统模型的重大飞跃，作为感知、规划和行动以实现特定目标的自主系统运行。这种技术的进步正在从单一的工具使用智能体转向处理多方面目标的复杂、协作的多智能体系统。

未来的假设预测通用、个性化甚至物理具身智能体的出现，它们将成为经济中的积极参与者。这种持续发展标志着向自我改进、目标驱动的系统的重大范式转变，这些系统将自动化整个工作流程并从根本上重新定义我们与技术的关系。

### 参考文献

1. Cloudera, Inc. (2025年4月)，96%的企业正在增加其对AI智能体的使用。https://www.cloudera.com/about/news-and-blogs/press-releases/2025-04-16-96-percent-of-enterprises-are-expanding-use-of-ai-agents-according-to-latest-data-from-cloudera.html
2. 自主生成式AI智能体：https://www.deloitte.com/us/en/insights/industry/technology/technology-media-and-telecom-predictions/2025/autonomous-generative-ai-agents-still-under-development.html
3. Market.us. 全球智能体AI市场规模、趋势和预测2025–2034。https://market.us/report/agentic-ai-market/

---

## 第1章：提示链

### 提示链模式概述

提示链，有时称为管道模式，代表了利用大型语言模型（LLMs）处理复杂任务的强大范式。与其期望LLM在单一的、整体的步骤中解决复杂问题，提示链提倡分而治之的策略。核心思想是将原始的、令人生畏的问题分解为一系列更小、更可管理的子问题。每个子问题通过专门设计的提示单独解决，一个提示生成的输出作为输入策略性地馈送到链中的后续提示。

这种顺序处理技术固有地在与LLMs的交互中引入了模块性和清晰性。通过分解复杂任务，更容易理解和调试每个单独步骤，使整个过程更健壮和可解释。链中的每个步骤都可以精心制作和优化，专注于更大问题的特定方面，导致更准确和集中的输出。

一个步骤的输出作为下一个步骤的输入至关重要。这种信息传递建立了依赖链，因此得名，其中先前操作的上下文和结果指导后续处理。这使得LLM能够在其先前工作基础上构建，完善其理解，并逐步接近期望的解决方案。

此外，提示链不仅仅是分解问题；它还使得能够集成外部知识和工具。在每个步骤，可以指示LLM与外部系统、API或数据库交互，丰富其超越其内部训练数据的知识和能力。这种能力极大地扩展了LLMs的潜力，使它们不仅作为隔离模型，而且作为更广泛、更智能系统的组成部分发挥作用。

提示链的意义超越了简单的问题解决。它作为构建复杂AI智能体的基础技术。这些智能体可以利用提示链在动态环境中自主规划、推理和行动。通过策略性地构建提示序列，智能体可以参与需要多步推理、规划和决策的任务。这种智能体工作流可以更紧密地模仿人类思维过程，允许与复杂域和系统进行更自然和有效的交互。

### 单个提示的局限性：

对于多方面任务，对LLM使用单个、复杂的提示可能效率低下，导致模型难以处理约束和指令，可能导致指令忽视，其中提示的部分被忽略；上下文漂移，其中模型失去初始上下文的跟踪；错误传播，其中早期错误放大；提示需要更长的上下文窗口，其中模型获得不足信息来响应；以及幻觉，其中认知负荷增加了错误信息的几率。例如，一个要求分析市场研究报告、总结发现、识别带数据点的趋势并起草电子邮件的查询有失败风险，因为模型可能总结良好但未能提取数据或正确起草电子邮件。

### 通过顺序分解增强可靠性：

提示链通过将复杂任务分解为专注的、顺序的工作流程来解决这些挑战，这显著提高了可靠性和控制。鉴于上述例子，管道或链接方法可以描述如下：

1. 初始提示（总结）："总结以下市场研究报告的关键发现：[文本]。"模型的唯一焦点是总结，增加了这个初始步骤的准确性。
2. 第二提示（趋势识别）："使用总结，识别三个新兴趋势并提取支持每个趋势的具体数据点：[步骤1的输出]。"这个提示现在更加受限，直接建立在验证输出之上。
3. 第三提示（电子邮件撰写）："为营销团队起草一个简洁的电子邮件，概述以下趋势及其支持数据：[步骤2的输出]。"

这种分解允许对过程更精细的控制。每个步骤更简单且更少歧义，这减少了模型的认知负荷，并导致更准确和可靠的最终输出。这种模块性类似于计算管道，其中每个函数在将其结果传递给下一个之前执行特定操作。为确保每个特定任务的准确响应，模型可以在每个阶段分配不同的角色。例如，在给定场景中，初始提示可以指定为"市场分析师"，后续提示为"贸易分析师"，第三提示为"专家文档撰写者"等等。

### 结构化输出的作用：

提示链的可靠性高度依赖于步骤之间传递的数据完整性。如果一个提示的输出模糊或格式不良，后续提示可能由于故障输入而失败。为了缓解这一点，指定结构化输出格式（如JSON或XML）至关重要。

例如，趋势识别步骤的输出可以格式化为JSON对象：

```json
{
"trends": [
{
"trend_name": "AI驱动的个性化",
"supporting_data": "73%的消费者更愿意与使用个人信息使其购物体验更相关的品牌做生意。"
},
{
"trend_name": "可持续和道德品牌",
"supporting_data": "具有ESG相关声明的产品销售额在过去五年中增长了28%，而没有ESG相关声明的产品增长了20%。"
}
]
}
```

这种结构化格式确保数据是机器可读的，并且可以精确解析并插入到下一个提示中而不会产生歧义。这种实践最大限度地减少了可能从解释自然语言中产生的错误，是构建健壮的多步LLM系统的一个关键组成部分。

### 实际应用和用例

提示链是一种多功能模式，适用于构建智能体系统时的各种场景。其核心实用性在于将复杂问题分解为顺序的、可管理的步骤。以下是几个实际应用和用例：

1. 信息处理工作流：许多任务涉及通过多个转换处理原始信息。例如，总结文档、提取关键实体，然后使用这些实体查询数据库或生成报告。提示链可能如下：
   - 提示1：从给定URL或文档提取文本内容。
   - 提示2：总结清理后的文本。
   - 提示3：从摘要或原始文本中提取特定实体（例如，姓名、日期、位置）。
   - 提示4：使用实体搜索内部知识库。
   - 提示5：生成包含摘要、实体和搜索结果的最终报告。

这种方法应用于自动内容分析、AI驱动研究助手开发和复杂报告生成等领域。

2. 复杂查询回答：回答需要多个推理或信息检索步骤的复杂问题是主要用例。例如，"1929年股市崩盘的主要原因是什么，政府政策如何回应？"
   - 提示1：识别用户查询中的核心子问题（崩盘原因、政府回应）。
   - 提示2：专门研究或检索关于1929年崩盘原因的信息。
   - 提示3：专门研究或检索关于政府对1929年股市崩盘政策回应的信息。
   - 提示4：将步骤2和3的信息综合成对原始查询的连贯回答。

这种顺序处理方法是开发能够进行多步推理和信息综合的AI系统的组成部分。当查询不能从单一数据点回答而是需要一系列逻辑步骤或来自多样化来源的信息集成时，需要这种系统。

例如，一个设计用于生成特定主题综合报告的自动研究智能体执行混合计算工作流。最初，系统检索大量相关文章。从每篇文章提取关键信息的后续任务可以为每个源并发执行。这个阶段非常适合并行处理，在那里独立子任务同时运行以最大化效率。然而，一旦个别提取完成，过程变得固有地顺序化。系统必须首先整理提取的数据，然后将其综合成连贯的草稿，最后审查和完善草稿以产生最终报告。这些后期阶段每个都在逻辑上依赖于前面阶段的成功完成。这里就是应用提示链的地方：整理的数据作为综合提示的输入，产生的综合文本成为最终审查提示的输入。因此，复杂操作经常将独立数据收集的并行处理与综合和完善步骤的提示链结合起来。

3. 数据提取和转换：将非结构化文本转换为结构化格式通常通过迭代过程实现，需要顺序修改以提高输出的准确性和完整性。
   - 提示1：尝试从发票文档中提取特定字段（例如，姓名、地址、金额）。
   - 处理：检查是否提取了所有必需字段以及它们是否符合格式要求。
   - 提示2（条件）：如果字段缺失或格式错误，制作新提示要求模型专门找到缺失/格式错误的信息，也许提供来自失败尝试的上下文。
   - 处理：再次验证结果。如有必要重复。
   - 输出：提供提取的、验证过的结构化数据。

这种顺序处理方法特别适用于从表单、发票或电子邮件等非结构化来源的数据提取和分析。例如，解决复杂光学字符识别（OCR）问题，如处理PDF表单，通过分解的多步骤方法更有效地处理。最初，使用大型语言模型对文档图像执行主要文本提取。在此之后，模型处理原始输出以规范化数据，在这个步骤中它可能将数字文本（如"一千零五十"）转换为数字等价物1050。LLMs执行精确数学计算的一个重要挑战。因此，在后续步骤中，系统可以将任何需要的算术操作委托给外部计算器工具。LLM识别必要的计算，将规范化的数字馈送到工具，然后整合精确结果。这种文本提取、数据规范化和外部工具使用的链接序列实现了最终的准确结果，这通常很难从单一LLM查询可靠获得。

4. 内容生成工作流：复杂内容的编写是一项程序性任务，通常分解为不同阶段，包括初始构思、结构大纲、起草和后续修订
   - 提示1：基于用户的一般兴趣生成5个主题想法。
   - 处理：允许用户选择一个想法或自动选择最好的一个。
   - 提示2：基于选定的主题生成详细大纲。
   - 提示3：基于大纲中的第一点起草部分。
   - 提示4：基于大纲中的第二点起草部分，提供前一部分作为上下文。对所有大纲点继续此操作。
   - 提示5：审查和完善完整草稿的连贯性、语调和语法。

这种方法用于一系列自然语言生成任务，包括创意叙事、技术文档和其他形式的结构化文本内容的自动编写。

5. 有状态的对话智能体：虽然全面的状态管理架构使用比顺序链接更复杂的方法，但提示链为保持对话连续性提供了基本机制。这种技术通过构建每个对话回合作为新的提示来维持上下文，该提示系统地整合对话序列中前面交互的信息或提取的实体。
   - 提示1：处理用户话语1，识别意图和关键实体。
   - 处理：用意图和实体更新对话状态。
   - 提示2：基于当前状态，生成回应和/或识别下一个需要的信息片段。
   - 为后续回合重复，每个新的用户话语启动一个利用积累对话历史（状态）的链。

这个原则是对话智能体开发的基础，使它们能够在扩展的多轮对话中维持上下文和连贯性。通过保留对话历史，系统可以理解和适当地响应依赖于先前交换信息的用户输入。

6. 代码生成和完善：功能代码的生成通常是一个多阶段过程，需要将问题分解为逐步执行的离散逻辑操作序列
   - 提示1：理解用户的代码功能请求。生成伪代码或大纲。
   - 提示2：基于大纲编写初始代码草稿。
   - 提示3：识别代码中的潜在错误或改进领域（也许使用静态分析工具或另一次LLM调用）。
   - 提示4：基于识别的问题重写或改进代码。
   - 提示5：添加文档或测试用例。

在AI辅助软件开发等应用中，提示链的实用性源于其将复杂编码任务分解为一系列可管理子问题的能力。这种模块化结构减少了大型语言模型在每个步骤的操作复杂性。关键是，这种方法还允许在模型调用之间插入确定性逻辑，使得在工作流内能够进行中间数据处理、输出验证和条件分支。通过这种方法，一个单一的、多方面的请求，否则可能导致不可靠或不完整的结果，被转换为由底层执行框架管理的结构化操作序列。

7. 多模态和多步推理：分析具有多样化模态的数据集需要将问题分解为更小的、基于提示的任务。例如，解释一个包含嵌入文本的图片、突出特定文本段的标签和解释每个标签的表格数据的图像，需要这种方法。
   - 提示1：从用户图像请求中提取和理解文本。
   - 提示2：将提取的图像文本与其相应标签链接。
   - 提示3：使用表格解释收集的信息以确定所需输出。

### 动手代码示例

实施提示链范围从脚本内的直接、顺序函数调用到利用专门设计用于管理控制流、状态和组件集成的框架。LangChain、LangGraph、Crew AI和谷歌智能体开发工具包（Google ADK）等框架为构建和执行这些多步骤过程提供了结构化环境，这对于复杂架构特别有利。

出于演示目的，LangChain和LangGraph是合适的选择，因为它们的核心API明确设计用于组合操作链和图。LangChain为线性序列提供基础抽象，而LangGraph将这些能力扩展到支持有状态和循环计算，这对于实现更复杂的智能体行为是必要的。本示例将专注于基本的线性序列。

以下代码实现了一个两步提示链，作为数据处理管道运行。初始阶段旨在解析非结构化文本并提取特定信息。后续阶段然后接收这个提取的输出并将其转换为结构化数据格式。

为了复制这个过程，必须首先安装所需的库。这可以使用以下命令完成：

```bash
pip install langchain langchain-community langchain-openai langgraph
```

注意，langchain-openai可以替换为适合不同模型提供者的相应包。随后，必须为所选语言模型提供者（如OpenAI、谷歌Gemini或Anthropic）配置执行环境与必要的API凭据。

```python
import os
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

# 为了更好的安全性，从.env文件加载环境变量
# from dotenv import load_dotenv
```