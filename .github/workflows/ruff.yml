name: Auto-fix Ruff Issues

on:
  push:
    paths:
      - "agents/**/*.py"
      - "tests/**/*.py"
      - "conftest.py"
      - "pyproject.toml"
      - "ruff.toml"
      - ".github/workflows/ruff.yml"
    branches-ignore:
      - "fix/ruff-auto-fix-*"
      - "dependabot/**"

# Workflow-level permissions
permissions:
  contents: write
  pull-requests: write
  # Additional permissions for gh CLI
  actions: read
  checks: write
  deployments: write
  issues: write
  packages: write
  repository-projects: write
  security-events: write
  statuses: write

# Environment variables
env:
  PYTHON_VERSION: "3.12"
  PR_LABELS: "auto-fix,ruff"
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  NOTIFICATION_ENABLED: ${{ vars.NOTIFICATION_ENABLED || 'false' }}
  EMAIL_NOTIFICATIONS: ${{ vars.EMAIL_NOTIFICATIONS || '' }}
  SMTP_SERVER: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
  SMTP_PORT: ${{ vars.SMTP_PORT || '587' }}

# Concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ruff-check-and-fix:
    name: Check and Fix Ruff Issues
    runs-on: ubuntu-latest
    # Skip if this is an auto-fix branch to avoid infinite loops
    if: "!startsWith(github.ref, 'refs/heads/fix/ruff-auto-fix-')"

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ruff-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-ruff-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff check (collect issues)
        id: ruff-check
        run: |
          # Create a report file for ruff issues
          ruff check agents/ tests/ conftest.py --output-format=json > ruff-issues.json || true

          # Count issues
          ISSUE_COUNT=$(cat ruff-issues.json | jq length || echo "0")
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT

          # Check if there are any fixable issues
          if [ $ISSUE_COUNT -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT

            # Try to fix issues
            ruff check agents/ tests/ conftest.py --fix

            # Check if any files were modified
            if [ -n "$(git status --porcelain)" ]; then
              echo "files_modified=true" >> $GITHUB_OUTPUT
              echo "Ruff found and fixed $ISSUE_COUNT issues"
            else
              echo "files_modified=false" >> $GITHUB_OUTPUT
              echo "Ruff found $ISSUE_COUNT issues but none were fixable"
            fi
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "No ruff issues found"
          fi

      - name: Run ruff format
        if: steps.ruff-check.outputs.has_issues == 'true'
        run: |
          ruff format agents/ tests/ conftest.py

          # Check if formatting made changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "formatting_changes=true" >> $GITHUB_ENV
          fi

      - name: Create summary
        run: |
          echo "## Ruff Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues found**: ${{ steps.ruff-check.outputs.issue_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files modified**: ${{ steps.ruff-check.outputs.files_modified }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.formatting_changes }}" == "true" ]; then
            echo "- **Formatting applied**: Yes" >> $GITHUB_STEP_SUMMARY
          fi

          # Show diff if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes made:" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  create-pr:
    name: Create/Update PR
    runs-on: ubuntu-latest
    needs: ruff-check-and-fix
    if: always() && needs.ruff-check-and-fix.result == 'success' && !startsWith(github.ref, 'refs/heads/fix/ruff-auto-fix-')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Check if fixes are needed
        id: check-fixes
        run: |
          # Store original state
          git stash push -m "temp-stash" --quiet

          # Run ruff check and fix
          ruff check agents/ tests/ conftest.py --fix --exit-zero
          ruff format agents/ tests/ conftest.py

          # Check if there are meaningful changes (excluding whitespace-only changes)
          STASH_RESULT=$(git stash pop --quiet)
          if [ -n "$(git diff --ignore-all-space)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Meaningful changes detected after applying ruff fixes"
            echo "Changes found:"
            git diff --name-only
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No meaningful changes needed"
            # Reset to avoid committing any formatting-only changes
            git reset --hard HEAD
          fi

      - name: Configure Git
        if: steps.check-fixes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure required labels exist
        if: steps.check-fixes.outputs.has_changes == 'true'
        run: |
          # Function to ensure label exists (create or update)
          create_label_if_missing() {
            local label_name="$1"
            local label_color="$2"
            local label_description="$3"

            echo "Ensuring label exists: $label_name"
            gh label create "$label_name" \
              --color "$label_color" \
              --description "$label_description" \
              --force || {
              echo "Warning: Failed to ensure label $label_name exists"
              # Continue without failing the step
            }
          }

          # Create required labels
          create_label_if_missing "auto-fix" "C5DEF5" "Automatically generated fixes"
          create_label_if_missing "ruff" "FFDAB9" "Ruff linting fixes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create branch and commit changes
        if: steps.check-fixes.outputs.has_changes == 'true'
        id: create-branch
        run: |
          # Use a consistent branch name to reuse existing PR
          BRANCH_NAME="fix/ruff-auto-fix"

          # Check if branch already exists
          if git fetch origin "$BRANCH_NAME" 2>/dev/null; then
            # Branch exists, check it out and pull latest changes
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME" --rebase
            echo "Reusing existing branch: $BRANCH_NAME"
          else
            # Branch doesn't exist, create it
            git checkout -b $BRANCH_NAME
            echo "Created new branch: $BRANCH_NAME"
          fi

          # Apply ruff fixes
          ruff check agents/ tests/ conftest.py --fix
          ruff format agents/ tests/ conftest.py

          # Add and commit changes
          git add agents/ tests/ conftest.py
          # Check if there are still changes to commit
          if [ -n "$(git diff --cached --ignore-all-space)" ]; then
            git commit -m "fix: auto-fix ruff issues

            - Applied ruff --fix to resolve linting issues
            - Applied ruff format for consistent formatting

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

            # Push branch
            git push origin "$BRANCH_NAME" --force-with-lease
            echo "Changes pushed to branch"
          else
            echo "No meaningful changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        if: steps.create-branch.outputs.has_changes != 'false'
        id: check-pr
        run: |
          # Search for existing auto-fix PR (using consistent branch name)
          PR_JSON=$(gh pr list --state open --label "auto-fix" --json number,headRefName --jq '.[] | select(.headRefName == "fix/ruff-auto-fix")')

          if [ -n "$PR_JSON" ]; then
            echo "has_existing=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found existing PR: #$PR_NUMBER"
          else
            echo "has_existing=false" >> $GITHUB_OUTPUT
            echo "No existing auto-fix PR found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new PR
        if: steps.check-fixes.outputs.has_changes == 'true' && steps.check-pr.outputs.has_existing == 'false'
        run: |
          # Generate PR body
          PR_BODY=$(cat <<EOF
          ## ğŸ¤– Auto-fix Ruff Issues

          This PR was automatically created to fix ruff linting issues found in commit ${{ github.sha }}.

          ### Changes Applied:
          - \`ruff check --fix\`: Fixed automatically fixable linting issues
          - \`ruff format\`: Applied consistent code formatting

          ### Next Steps:
          - Review the changes
          - If everything looks good, merge this PR
          - If you see issues, you can:
            - Close this PR without merging
            - Manually fix the remaining issues in your branch
            - Add exceptions to your ruff configuration if needed

          ---
          *This PR was created automatically by GitHub Actions*
          EOF
          )

          # Create PR
          # Get the default branch as base
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          gh pr create \
            --title "fix: auto-fix ruff issues" \
            --body "$PR_BODY" \
            --base "$DEFAULT_BRANCH" \
            --head "${{ steps.create-branch.outputs.branch_name }}" \
            --label "${{ env.PR_LABELS }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR (if needed)
        if: steps.check-pr.outputs.has_existing == 'true' && steps.create-branch.outputs.branch_name == 'fix/ruff-auto-fix'
        run: |
          echo "Existing PR already exists for consistent branch name"
          echo "No update needed - the PR will be automatically updated when branch is pushed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Note: No comment step needed since this workflow only triggers on push

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [ruff-check-and-fix, create-pr]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.create-pr.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Auto-fix process completed successfully" >> $GITHUB_OUTPUT
          elif [ "${{ needs.create-pr.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Auto-fix process encountered errors" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=No fixes were needed" >> $GITHUB_OUTPUT
          fi

      - name: Log results
        run: |
          echo "## Ruff Auto-fix Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message**: ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Get PR info
        id: get-pr
        if: needs.create-pr.result == 'success'
        run: |
          # Search for auto-fix PR created in the last hour
          PR_JSON=$(gh pr list \
            --author "github-actions[bot]" \
            --label "auto-fix" \
            --limit 1 \
            --state open \
            --json number,url \
            --jq '.[0] || empty')

          if [ -n "$PR_JSON" ]; then
            echo "pr_number=$(echo "$PR_JSON" | jq -r '.number')" >> $GITHUB_OUTPUT
            echo "pr_url=$(echo "$PR_JSON" | jq -r '.url')" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack notification
        if: env.NOTIFICATION_ENABLED == 'true' && env.SLACK_WEBHOOK_URL != ''
        run: |
          # Prepare notification message
          if [ "${{ steps.status.outputs.status }}" == "success" ]; then
            EMOJI="ğŸ¯"
            TITLE="Ruff è‡ªåŠ¨ä¿®å¤å®Œæˆ"
          elif [ "${{ steps.status.outputs.status }}" == "failure" ]; then
            EMOJI="âŒ"
            TITLE="Ruff è‡ªåŠ¨ä¿®å¤å¤±è´¥"
          else
            EMOJI="â„¹ï¸"
            TITLE="Ruff è‡ªåŠ¨ä¿®å¤ï¼šæ— éœ€æ“ä½œ"
          fi

          # Set environment variables for email notification
          echo "EMOJI=$EMOJI" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV

          # Create Slack message
          SLACK_MESSAGE=$(cat <<EOF
          ${EMOJI} *${TITLE}*

          ğŸ“‚ åˆ†æ”¯: ${GITHUB_REF_NAME}
          ğŸ‘¤ æäº¤è€…: ${GITHUB_ACTOR}
          ğŸ“Š çŠ¶æ€: ${{ steps.status.outputs.status }}
          â„¹ï¸ è¯¦æƒ…: ${{ steps.status.outputs.message }}
          EOF
          )

          # Add PR link if available
          if [ -n "${{ steps.get-pr.outputs.pr_number }}" ]; then
            SLACK_MESSAGE=$(cat <<EOF
          ${SLACK_MESSAGE}

          ğŸ”— åˆ›å»ºçš„ PR: <${{ steps.get-pr.outputs.pr_url }}|#${{ steps.get-pr.outputs.pr_number }}>
          EOF
          )
          fi

          # Add workflow link
          SLACK_MESSAGE=$(cat <<EOF
          ${SLACK_MESSAGE}

          ğŸ”— æŸ¥çœ‹è¿è¡Œ: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>
          EOF
          )

          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$SLACK_MESSAGE\"}" \
            "$SLACK_WEBHOOK_URL"

      - name: Send email notification
        if: env.NOTIFICATION_ENABLED == 'true' && env.EMAIL_NOTIFICATIONS != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_SERVER }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ env.EMOJI }} Ruff è‡ªåŠ¨ä¿®å¤é€šçŸ¥ - ${{ env.TITLE }}"
          to: ${{ env.EMAIL_NOTIFICATIONS }}
          from: GitHub Actions <${{ secrets.EMAIL_FROM || github.actor }}@users.noreply.github.com>
          # Convert markdown to HTML for email
          html_body: |
            <h2>${{ env.EMOJI }} ${{ env.TITLE }}</h2>
            <p>ä»¥ä¸‹æ˜¯ä» <strong>${{ github.repository }}</strong> ä»“åº“çš„è‡ªåŠ¨ä¿®å¤é€šçŸ¥ï¼š</p>
            <ul>
              <li><strong>åˆ†æ”¯</strong>: ${{ github.ref_name }}</li>
              <li><strong>æäº¤è€…</strong>: ${{ github.actor }}</li>
              <li><strong>çŠ¶æ€</strong>: ${{ steps.status.outputs.status }}</li>
              <li><strong>è¯¦æƒ…</strong>: ${{ steps.status.outputs.message }}</li>
            </ul>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹ GitHub Actions è¿è¡Œè¯¦æƒ…</a></p>
            ${{ steps.get-pr.outputs.pr_number && format('<p><a href="{0}">æŸ¥çœ‹åˆ›å»ºçš„ PR #{1}</a></p>', steps.get-pr.outputs.pr_url, steps.get-pr.outputs.pr_number) || '' }}
          body: |
            ${{ env.TITLE }}

            ä»“åº“: ${{ github.repository }}
            åˆ†æ”¯: ${{ github.ref_name }}
            æäº¤è€…: ${{ github.actor }}
            çŠ¶æ€: ${{ steps.status.outputs.status }}
            è¯¦æƒ…: ${{ steps.status.outputs.message }}

            æŸ¥çœ‹è¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ${{ steps.get-pr.outputs.pr_number && format('PR: #%s - %s', steps.get-pr.outputs.pr_number, steps.get-pr.outputs.pr_url) || '' }}
